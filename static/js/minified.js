var templates={route:"  <div>    <h2> <%= title %> </h2>    <h3> <%= direction %> </h3>    <% if (Array.isArray(predictions)) { _.each(predictions, function(value) { %>      <li>         <ul><%= Math.floor(value['@seconds']/ 60) < 2 ? 'Arriving soon!' : Math.floor(value['@seconds']/60) + ' minutes' %></ul>       </li>    <% })} else { if (predictions['@seconds'] == null) { %>      <p> Bus not in service. </p>     <% } else { %>      <li>         <ul><%= Math.floor(predictions['@seconds']/ 60) < 2 ? 'Arriving soon!' : Math.floor(predictions['@seconds']/60) + ' minutes' %></ul>       </li>    <%}}; %>  </div>",
welcome:"   <div class='bbm-modal__topbar'>       <h3 class='bbm-modal__title'>CloseBus</h3>     </div>    <div class='bbm-modal__section'>      <p>Realtime arrival estimates on nearby busses!</p>      <ul>        <li>Click on a bus for realtime arrival estimates via NextBus API.</li>        <li>Drag the red marker to update your location.</li>        <li>Help me grow! Feel free to play around -- as you explore, the app will learn new bus stops :)</li>      </ul>    </div>    <div class='bbm-modal__bottombar'>      <span style='float-left'>&copy; Chris Best 2014</span>      <a href='#' class='bbm-button'>Close</a>  </div>",
website:"<a target='_blank' href='<%= website %>' >Route Info</a>"};var RoutesModel=Backbone.Model.extend({init:function(a){this.agency=a.agency;this.stop_id=a.stop_id;this.website=a.website;this.view=a.view},url:function(){return"api/v1/departures/"+this.get("agency")+"/"+this.get("stop_id")},parse:function(a){var b=this,d=_.map(_.keys(a),function(a){var b={};b[a]={};return b});this.set("busses",d);_.each(this.get("busses"),function(d,c){var e=b.get("busses"),f=_.keys(e[c])[0];null===a[f]?(e[c].title=f,e[c].direction=null,e[c].predictions={"@seconds":null}):Array.isArray(a[f])?
(e[c].title=f,e[c].direction=a[f][0]["@title"],e[c].predictions=a[f][0].prediction):(e[c].title=f,e[c].direction=a[f]["@title"],e[c].predictions=a[f].prediction)});this.attributes.view.render()}}),StopModel=Backbone.Model.extend({urlRoot:"/api/v1/stop_id/",defaults:{id:null,name:null,stop_ids:null,url:null,website:null,location:null}}),StopCollection=Backbone.Collection.extend({url:"#",model:StopModel});var MapView=Backbone.View.extend({el:$("#app"),initialize:function(){function a(a){a=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);d.buildMap(a)}function b(){var a=new google.maps.LatLng(37.8717775,-122.2676512);d.buildMap(a)}var d=this;"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(a,b)},buildMap:function(a){var b={zoom:17,mapTypeId:google.maps.MapTypeId.ROADMAP,center:a,styles:[{elementType:"geometry",stylers:[{lightness:40},{saturation:-80}]}]};this.map=new google.maps.Map(document.getElementById("map_canvas"),
b);this.buildDraggable(a);this.buildCircle(a);this.findNearbyStops(a)},buildDraggable:function(a){var b=this,d=new google.maps.Marker({position:a,map:this.map,draggable:!0,title:""});google.maps.event.addListener(d,"dragend",function(){var a=d.getPosition();b.buildCircle(a);b.findNearbyStops(a);b.map.panTo(a)})},buildCircle:function(a){this.radius&&this.radius.setMap(null);this.radius=new google.maps.Circle({strokeColor:"#FFFFFF",strokeOpacity:.8,strokeWeight:2,fillColor:"#FFFFFF",fillOpacity:.35,
zIndex:-2,map:this.map,center:a,radius:200})},findNearbyStops:function(a){var b=this;a={location:a,radius:200,types:["bus_station"]};(new google.maps.places.PlacesService(this.map)).search(a,function(a,g){g==google.maps.places.PlacesServiceStatus.OK&&(b.StopCollection=new StopCollection,_.each(a,function(a){a=new StopModel({id:a.place_id,location:a.geometry.location});b.StopCollection.add(a)}));b.buildStops()})},buildStops:function(){var a=this;a.StopCollection.each(function(b){b.fetch({success:function(b){var g=
{"http://pt.berkeley.edu/around/transit/shuttles":"images/berkeley.png","http://www.actransit.org/":"images/ac.png","http://www.sfmta.com/":"images/muni.png"};if(0<=["actransit","berkeley"].indexOf(b.attributes.agency)&&"Unavailable"!==b.attributes.stop_ids){var g={url:g[b.attributes.website],scaledSize:new google.maps.Size(24,32),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,0)},c=new google.maps.Marker({map:a.map,position:b.attributes.location,icon:g,zIndex:1,title:b.attributes.name,
stop_ids:b.attributes.stop_ids,website:b.attributes.website,agency:b.attributes.agency});google.maps.event.addListener(c,"click",function(){a.buildWindow(c)})}},error:function(a,b){console.log(a,b)}})})},buildWindow:function(a){var b=new google.maps.InfoWindow({content:"Loading.."});b.open(this.map,a);this.getTimes(a,b)},getTimes:function(a,b){(new RouteView({agency:a.agency,stop_id:a.stop_ids[0],website:a.website,infowindow:b})).model.fetch()},renderResponse:function(a){_.each(a,function(a,d){new RouteView({title:a["@title"],
predictions:a.prediction,parent:null})})}}),StopView=Backbone.View.extend({el:"#routes",template:_.template(""),initialize:function(a){this.children=a.children||null;this.title=a.title||null},render:function(){this.template}}),RouteView=Backbone.View.extend({el:$("#sup")[0],routeTemplate:_.template(templates.route),websiteTemplate:_.template(templates.website),initialize:function(a){this.parent=a.parent;this.infowindow=a.infowindow;this.model=new RoutesModel({title:a.title,agency:a.agency,stop_id:a.stop_id,
predictions:a.predictions,website:a.website,view:this})},render:function(){var a=this,b="";_.each(this.model.get("busses"),function(d){d=a.routeTemplate(d);b+=d});b+=a.websiteTemplate(this.model.attributes);this.infowindow.setContent(b);return this}}),WelcomeView=Backbone.Modal.extend({template:_.template(templates.welcome),cancelEl:".bbm-button"});var Map=null,Welcome=null;$(function(){Map=new MapView;Welcome=new WelcomeView;$("#modal").html(Welcome.render().el)});